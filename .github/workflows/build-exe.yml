# ============================================================================
# AETHER AUDIO ARCHIVIST PRO — Windows EXE Build Pipeline
# Architect: Matthew Bubb
# ============================================================================
# Compiles the Python TUI into a standalone Windows executable with all
# dependencies bundled (Playwright Chromium, FFmpeg, yt-dlp, etc).
# Users download a single zip, extract, and double-click AetherArchivist.exe.
# ============================================================================

name: Build Windows EXE

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    env:
      PLAYWRIGHT_BROWSERS_PATH: 0   # Install browsers into the package itself

    steps:
      # ── Checkout ──────────────────────────────────────────────
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ── Python Setup ──────────────────────────────────────────
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip

      - name: Install Python Dependencies
        run: pip install -r requirements.txt

      # ── Playwright Chromium ───────────────────────────────────
      - name: Install Playwright Chromium
        run: python -m playwright install chromium

      # ── FFmpeg (static Windows build) ─────────────────────────
      - name: Download FFmpeg
        shell: pwsh
        run: |
          $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile ffmpeg.zip
          Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg_extract -Force
          # Locate the bin directory (nested inside a versioned folder)
          $binDir = Get-ChildItem -Path ffmpeg_extract -Recurse -Directory -Filter "bin" | Select-Object -First 1
          New-Item -ItemType Directory -Path "ffmpeg_bundle" -Force | Out-Null
          Copy-Item "$($binDir.FullName)\ffmpeg.exe"  "ffmpeg_bundle\ffmpeg.exe"
          Copy-Item "$($binDir.FullName)\ffprobe.exe" "ffmpeg_bundle\ffprobe.exe"
          Write-Host "FFmpeg binaries staged in ffmpeg_bundle/"

      # ── Resolve Playwright Browser Path ───────────────────────
      - name: Locate Playwright Chromium
        id: pw-path
        shell: pwsh
        run: |
          $pkgDir = python -c "import playwright; import os; print(os.path.dirname(playwright.__file__))"
          $driverDir = Join-Path $pkgDir "driver" "package" ".local-browsers"
          if (-not (Test-Path $driverDir)) {
            # Fallback: check the package-level path
            $driverDir = Join-Path $pkgDir "driver" "package" ".local-browsers"
          }
          # Find the actual chromium directory
          $chromiumDir = Get-ChildItem -Path $driverDir -Recurse -Directory -Filter "chromium-*" | Select-Object -First 1
          if ($null -eq $chromiumDir) {
            $chromiumDir = Get-ChildItem -Path $driverDir -Directory | Select-Object -First 1
          }
          Write-Host "Playwright browser dir: $($chromiumDir.FullName)"
          echo "BROWSER_DIR=$($chromiumDir.FullName)" >> $env:GITHUB_OUTPUT

      # ── PyInstaller Build ─────────────────────────────────────
      - name: Build EXE with PyInstaller
        shell: pwsh
        run: |
          $browserDir = "${{ steps.pw-path.outputs.BROWSER_DIR }}"

          pyinstaller `
            --noconfirm `
            --name "AetherArchivist" `
            --console `
            --add-data "ffmpeg_bundle;ffmpeg_bundle" `
            --add-data "${browserDir};playwright_browser" `
            --hidden-import "textual" `
            --hidden-import "textual.app" `
            --hidden-import "textual.widgets" `
            --hidden-import "textual.containers" `
            --hidden-import "textual.binding" `
            --hidden-import "textual.reactive" `
            --hidden-import "textual.screen" `
            --hidden-import "textual.message" `
            --hidden-import "textual.widget" `
            --hidden-import "textual.strip" `
            --hidden-import "textual.css" `
            --hidden-import "textual.css.query" `
            --hidden-import "textual._xterm_parser" `
            --hidden-import "textual._animator" `
            --hidden-import "rich" `
            --hidden-import "rich.text" `
            --hidden-import "rich.segment" `
            --hidden-import "rich.style" `
            --hidden-import "rich.console" `
            --hidden-import "rich.markup" `
            --hidden-import "rich.traceback" `
            --hidden-import "yt_dlp" `
            --hidden-import "mutagen" `
            --hidden-import "mutagen.id3" `
            --hidden-import "mutagen.id3._frames" `
            --hidden-import "PIL" `
            --hidden-import "PIL.Image" `
            --hidden-import "playwright" `
            --hidden-import "playwright.async_api" `
            --collect-all "textual" `
            --collect-all "rich" `
            --collect-all "yt_dlp" `
            --collect-all "mutagen" `
            --collect-all "playwright" `
            --collect-submodules "textual" `
            --collect-submodules "rich" `
            "Aether_Audio_Archivist_Pro.py"

          Write-Host "Build complete. Contents of dist/AetherArchivist/:"
          Get-ChildItem "dist\AetherArchivist" | Format-Table Name, Length

      # ── Create Launcher Script ────────────────────────────────
      - name: Create Launcher Script
        shell: pwsh
        run: |
          # Write a small wrapper that sets PATH for ffmpeg and PLAYWRIGHT env
          $launcher = @'
          @echo off
          title Aether Audio Archivist Pro - Matthew Bubb
          set "SCRIPT_DIR=%~dp0"
          set "PATH=%SCRIPT_DIR%ffmpeg_bundle;%PATH%"
          set "PLAYWRIGHT_BROWSERS_PATH=%SCRIPT_DIR%playwright_browser"
          start "" "%SCRIPT_DIR%AetherArchivist.exe"
          '@
          Set-Content -Path "dist\AetherArchivist\Launch_Aether.bat" -Value $launcher
          Write-Host "Launcher script created."

      # ── Zip the Build ─────────────────────────────────────────
      - name: Package Release Zip
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\AetherArchivist\*" -DestinationPath "AetherArchivist-Windows-x64.zip" -Force
          $size = (Get-Item "AetherArchivist-Windows-x64.zip").Length / 1MB
          Write-Host "Release zip: $([math]::Round($size, 1)) MB"

      # ── Upload as Artifact ────────────────────────────────────
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AetherArchivist-Windows-x64
          path: AetherArchivist-Windows-x64.zip
          retention-days: 30

      # ── Create GitHub Release (on tag push) ───────────────────
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: "Aether Audio Archivist Pro ${{ github.ref_name }}"
          body: |
            ## Aether Audio Archivist Pro — Standalone Windows Build

            **Architected by Matthew Bubb**

            Download `AetherArchivist-Windows-x64.zip`, extract anywhere, and run `Launch_Aether.bat`.
            No Python, Node, or FFmpeg installation required.
          files: AetherArchivist-Windows-x64.zip
          draft: false
          prerelease: false
